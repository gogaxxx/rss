#!/usr/bin/perl

use strict;
use warnings;

use Agg::Config;
use Agg::Download;
use Digest::MD5 qw(md5_hex);
use XML::Parser;

our $type;

MAIN: {
    my $url = $ARGV[0];

    unless ($url) {
        die("Specify url");
    }

	my $root = Agg::Config->CONFIG_DIR;
	my $dir = md5_hex($url);
	mkdir($root.'/'.$dir) || die("Can't create dir $dir: $!");

	my $config = $root.'/'.$dir.'/config';
	my $cache  = $root.'/'.$dir.'/cache';

	my $content = Agg::Download->mirror($url, $cache);

	my $parser = XML::Parser->new();
	$parser->setHandlers(Start => \&xml_start_detect);
	$parser->parse($content);

	open (CFG, '>'.$config)
		|| die("Can't open config file $config: $!");
	print CFG "url=$url\n";
	print CFG "type=$type\n";
	close CFG;

	print "Successfully added\n\n";
}

#+++1 xml_start_detect
sub xml_start_detect {
    my ($expat, $elem)=@_;

    if ($elem eq 'feed') {
        $type = 'atom';
    }
    elsif ($elem eq 'rss'
            || lc($elem) eq 'rdf:rdf')
    {
        $type = 'rss';
    }
    else {
        die'UNKNOWN TYPE '.$elem;
    }
    $expat->finish();
}
