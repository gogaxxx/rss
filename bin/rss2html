#!/usr/bin/perl
#
#
#

use strict;
use warnings;

use Agg::Config;
use Agg::Item;
use Agg::Transform;

use Getopt::Std;

MAIN: {
	my %opts;

#pods#+++
=head2 OPTIONS

=over

=item -a

Load ALL items in master index (by default load only new items)

=back

=cut
#---

	getopts('a', \%opts);
	my $feed_id = $ARGV[0] || die("Specify feed id");

	my $cfg = Agg::Config->get_config_by_id($feed_id);

	# грузим master
	my $index = 
		$opts{'a'}
			? $cfg->{'master'}
			: $cfg->{'news'};
	my @master = ();
	open(INDEX, '<'.$index) 
		|| die("Can't open ".$index.": $!");
	while (my $line = <INDEX>) {
		chomp $line;

		# XXX возможно добавить фильтрацию по времени, например

		push @master,
			[ split(/\s+/o, $line, 3) ];
	}
	close INDEX;

	# сортируем по времени
	@master = sort { $a->[0] <=> $b->[0] } @master;

    my $itemizer = Agg::Item->new($cfg);
    my $transform = Agg::Transform->new($cfg);

    my $outfile = $cfg->{readdir}.'/'.$cfg->{name}.'.html';
	open(OUT, '>'.$outfile) || die("Can't open $outfile: $!");
    
    for my $i (@master) {
        my $item = $itemizer->load_item($i->[1]);
        $transform->transform_item($item);

        # XXX вместо utf-8 сделать конфигурируемый параметр
        print OUT Encode::encode($cfg->{'encoding'}, '<h1>'.$item->{subject}.'<br></h1>');
        print OUT Encode::encode($cfg->{'encoding'}, '<div class=body>'.$item->{body}.'</div>');
        print OUT "<hr>\n";
    }
    close OUT;
}
