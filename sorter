#!/usr/bin/perl

use strict;
use lib '.';
use cfg;

use File::Copy;

my @to_process = @ARGV;

for my $pindex (@to_process) {
	my $p = $cfg::to_process{$pindex};

    unless (defined($p)) {
        die("No configuration for '$pindex' in cfg\n");
    }

    $p->{'sorting'}  ||= $cfg::sorting;
    $p->{'maxitems'} ||= $cfg::maxitems;

	open (ORDER, '<'.$p->{'input'});
	my @order = ();
	while (my $line1 = <ORDER>) {

		chomp $line1;
		my @fields = split(/\s+/o, $line1);

		push @order, [ @fields ];
	}
	close(ORDER);

	@order = sort { $a->[0] <=> $b->[0] } @order;

	my $part = 0;
	my $item = 0;
	my @piece_of_lenta = ();

	my $l = scalar(@order);
	for (my $i = 0; $i < $l; $i++) {
	#    print (":", $f->[1], " - ", $part, "\n");
		my $f = $order[$i];

		open(FILE, '<'.$cfg::items_dir.'/'.$f->[1]);
		my $chunk = join('', <FILE>);
		close FILE;
        if ($p->{'sorting'} eq 'new_first') {
		    unshift @piece_of_lenta, $chunk;
        }
        elsif ($p->{'sorting'} eq 'old_first') {
            push @piece_of_lenta, $chunk;
        }
		$item ++;

		if ($item >= $p->{'maxitems'}) {
			$part ++;
            open(OUTPUT, '>'.sprintf($p->{'output_tmp'}, $part));
			print OUTPUT @piece_of_lenta;
			print OUTPUT prev_part($p, $part), 
                         '&nbsp;&nbsp;',
                         ($i < $l-1 
						 	? next_part($p, $part) 
							: '');
			close OUTPUT;

			$item=0;
			@piece_of_lenta = ();
		}
	}
	if ($item > 0) {
        $part ++;
        open(OUTPUT, '>'.sprintf($p->{'output_tmp'}, $part));
		print OUTPUT @piece_of_lenta;
		print OUTPUT prev_part($p, $part);
        close OUTPUT;
	}

    my $filename = 
        $p->{'sorting'} eq 'new_first'
            ? sprintf($p->{'output_tmp'}, $part)
            : 
        $p->{'sorting'} eq 'old_first'
            ? sprintf($p->{'output_tmp'}, 1)
            : '';

	copy($filename, $p->{'output_start'});
}

sub prev_part {
	my $p = shift;
	my $part = shift;

	$part > 1 
		? q{<a href="}.sprintf($p->{'output_tmp'}, $part-1).q{">&lt;&lt;Older</a>}
		: '';
}

sub next_part {
	my $p = shift;
	my $part = shift;
	 q{<a href="}.sprintf($p->{'output_tmp'}, $part+1).q{">Newer&gt;&gt;</a>}
}
