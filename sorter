#!/usr/bin/perl

use strict;
use lib '.';
use cfg;

use File::Copy;

my @to_process = @ARGV;

for my $pindex (@to_process) {
	my $p = $cfg::to_process{$pindex};

    unless (defined($p)) {
        die("No configuration for '$pindex' in cfg\n");
    }

    $p->{'sorting'}  ||= $cfg::sorting;
    $p->{'maxitems'} ||= $cfg::maxitems;

	open (ORDER, '<'.$p->{'input'});
	my @order = ();
	while (my $line1 = <ORDER>) {

		chomp $line1;
		my @fields = split(/\s+/o, $line1);

		push @order, [ @fields ];
	}
	close(ORDER);

	@order = sort { $a->[0] <=> $b->[0] } @order;

	my $part = 0;
	my $item = 0;
	my @piece_of_lenta = ();

	my $l = scalar(@order);

	my $style_links =
		[
			'<link rel="stylesheet" type="text/css" href="'.$p->{style}.'">'
		];

	for (my $i = 0; $i < $l; $i++) {
	#    print (":", $f->[1], " - ", $part, "\n");
		my $f = $order[$i];

		open(FILE, '<'.$cfg::items_dir.'/'.$f->[1]);
		my $chunk = join('', <FILE>);
		close FILE;
        if ($p->{'sorting'} eq 'new_first') {
		    unshift @piece_of_lenta, $chunk;
        }
        elsif ($p->{'sorting'} eq 'old_first') {
            push @piece_of_lenta, $chunk;
        }
		$item ++;

		if ($item >= $p->{'maxitems'}) {
			$part ++;

			my $prev_links = prev_part($p, $part);
			my $next_links = ($i < $l-1 
						 		? next_part($p, $part) 
								: ['','']);
            open(OUTPUT, '>'.sprintf($p->{'output_tmp'}, $part));
			print OUTPUT '<html>';
			print OUTPUT header($prev_links, $next_links, $style_links);
			print OUTPUT @piece_of_lenta;
			print OUTPUT $prev_links->[1],
                         '&nbsp;&nbsp;',
						 $next_links->[1];
			print OUTPUT '</html>';
			close OUTPUT;

			$item=0;
			@piece_of_lenta = ();
		}
	}
	if ($item > 0) {
        $part ++;
		my $prev_links = prev_part($p, $part);
        open(OUTPUT, '>'.sprintf($p->{'output_tmp'}, $part));
		print OUTPUT header($prev_links, $style_links);
		print OUTPUT @piece_of_lenta;
		print OUTPUT $prev_links->[1];
        close OUTPUT;
	}

    my $filename = 
        $p->{'sorting'} eq 'new_first'
            ? sprintf($p->{'output_tmp'}, $part)
            : 
        $p->{'sorting'} eq 'old_first'
            ? sprintf($p->{'output_tmp'}, 1)
            : '';

	copy($filename, $p->{'output_start'});
}

sub prev_part {
	my $p = shift;
	my $part = shift;

	if ($part > 1) {
		my $href = sprintf($p->{'output_tmp'}, $part-1);
		return 
			[
				q{<link rel="prev" href="}.$href.'">',
				q{<a href="}.$href.q{">&lt;&lt;Older</a>}
			]
	}
	else {
		return [ '', ''];
	}
}

sub next_part {
	my $p = shift;
	my $part = shift;

	my $href = sprintf($p->{'output_tmp'}, $part+1);
	return
		[
			q{<link rel="next" href="}.$href.'">',
	 		q{<a href="}.$href.q{">Newer&gt;&gt;</a>}
		];
}

sub header {
	return ('<head>', 
			(map { $_->[0]} @_),
			'</head>');
}
